name: Build and Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [chrome-mv3, firefox-mv3]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build extension
        run: bun run build --target=${{ matrix.target }}

      - name: Add Firefox-specific manifest settings
        if: matrix.target == 'firefox-mv3'
        run: |
          cd build/firefox-mv3-prod
          # Add webRequest permission for Firefox (only if not already present)
          jq 'if (.permissions | index("webRequest")) then . else .permissions += ["webRequest"] end' manifest.json > manifest.tmp && mv manifest.tmp manifest.json
          # Add browser_specific_settings for Firefox with a valid extension ID (email-like format, no slashes)
          jq '.browser_specific_settings = {"gecko": {"id": "leetcode-pishock@stack1ng.github.io", "strict_min_version": "109.0"}}' manifest.json > manifest.tmp && mv manifest.tmp manifest.json
          cat manifest.json

      - name: Package extension
        run: bun run package --target=${{ matrix.target }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}-build
          path: build/${{ matrix.target }}-prod.zip
          retention-days: 1

  sign-chrome:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download Chrome build
        uses: actions/download-artifact@v4
        with:
          name: chrome-mv3-build

      - name: Unzip Chrome extension
        run: |
          mkdir -p extension
          unzip chrome-mv3-prod.zip -d extension

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Create private key file
        run: echo "${{ secrets.CHROME_EXTENSION_KEY }}" > key.pem

      - name: Sign Chrome extension as CRX
        run: |
          npm install -g crx
          crx pack extension -o leetcode-pishock-chrome.crx -p key.pem

      - name: Clean up key
        run: rm -f key.pem

      - name: Upload signed Chrome extension
        uses: actions/upload-artifact@v4
        with:
          name: chrome-signed
          path: leetcode-pishock-chrome.crx
          retention-days: 1

  sign-firefox:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download Firefox build
        uses: actions/download-artifact@v4
        with:
          name: firefox-mv3-build

      - name: Unzip Firefox extension
        run: |
          mkdir -p extension
          unzip firefox-mv3-prod.zip -d extension

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Checkout repository for source code
        uses: actions/checkout@v4

      - name: Sign Firefox extension
        run: |
          npm install -g web-ext
          # Create source archive for AMO validation (helps with minified file warnings)
          zip -r source.zip . -x "node_modules/*" -x "build/*" -x ".git/*" -x "*.zip"
          web-ext sign \
            --source-dir=extension \
            --artifacts-dir=. \
            --api-key=${{ vars.AMO_JWT_ISSUER }} \
            --api-secret=${{ secrets.AMO_JWT_SECRET }} \
            --channel=unlisted \
            --approval-timeout=900000 \
            --upload-source-code=source.zip
          # Rename to consistent filename (find the xpi file that was created)
          mv *.xpi leetcode-pishock-firefox.xpi

      - name: Upload signed Firefox extension
        uses: actions/upload-artifact@v4
        with:
          name: firefox-signed
          path: leetcode-pishock-firefox.xpi
          retention-days: 1

  release:
    needs: [sign-chrome, sign-firefox]
    runs-on: ubuntu-latest

    steps:
      - name: Download all signed artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*-signed"
          merge-multiple: true

      - name: List artifacts
        run: ls -la

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            leetcode-pishock-chrome.crx
            leetcode-pishock-firefox.xpi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
